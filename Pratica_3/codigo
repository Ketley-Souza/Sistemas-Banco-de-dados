CREATE TABLE combustivel (
  combustivel_id INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  nome VARCHAR(100) NOT NULL,
  estoque_l NUMERIC(12,3) NOT NULL DEFAULT 0,
  CONSTRAINT combustivel_nome_uniq UNIQUE (nome)
)

CREATE TABLE funcionario (
  funcionario_id INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  nome VARCHAR(150) NOT NULL,
  ativo BOOLEAN NOT NULL DEFAULT true
)

CREATE TABLE venda (
  venda_id INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  data_hora TIMESTAMPTZ NOT NULL DEFAULT now(),
  funcionario_id INT REFERENCES funcionario(funcionario_id) ON DELETE SET NULL,
  total NUMERIC(12,2) NOT NULL CHECK (total >= 0)
)

CREATE TABLE venda_item (
  venda_item_id INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  venda_id INT NOT NULL REFERENCES venda(venda_id) ON DELETE CASCADE,
  combustivel_id INT NOT NULL REFERENCES combustivel(combustivel_id),
  quantidade_l NUMERIC(12,3) NOT NULL CHECK (quantidade_l >= 0),
  preco_unitario NUMERIC(12,4) NOT NULL CHECK (preco_unitario >= 0)
)

CREATE INDEX idx_venda_data_hora ON venda (data_hora)
CREATE INDEX idx_venda_item_combustivel ON venda_item (combustivel_id)


--INSERCOES INICIAIS
INSERT INTO combustivel (nome, estoque_l) VALUES
  ('Gasolina', 5000),
  ('Etanol', 3000),
  ('Diesel', 8000),
  ('GNV', 1500);

INSERT INTO funcionario (nome, ativo) VALUES
  ('João Silva', true),
  ('Maria Oliveira', true),
  ('Carlos Souza', false);



INSERT INTO venda (data_hora, funcionario_id, total) VALUES
  ('2025-11-01 09:15:00-03', 1, 210.04),
  ('2025-11-01 10:05:00-03', 2, 150.12),
  ('2025-11-01 11:00:00-03', 1,  50.15),
  ('2025-11-01 11:30:00-03', 1,  80.28),
  ('2025-11-01 11:32:00-03', 2, 110.16),
  ('2025-11-01 12:32:00-03', 2, 217.50)

INSERT INTO venda_item (venda_id, combustivel_id, quantidade_l, preco_unitario) VALUES
  (1, 1, 20.0, 7.5375),
  (1, 2, 15.0, 5.0000),
  (2, 3, 30.0, 6.6667);


--Inserir um combustivel com nome duplicado e observar a violação de UNIQUE
INSERT INTO combustivel (nome, estoque_l) VALUES
  ('Gasolina', 4000);  


--Modifique a query para mostrar apenas combustíveis com estoque maior que 1000 litros
SELECT
  c.combustivel_id,
  c.nome,
  c.estoque_l
FROM
  combustivel AS c
ORDER BY c.estoque_l DESC;

SELECT
    c.nome,
    c.estoque_l
FROM 
    combustivel AS c
WHERE
    c.estoque_l > 1000
ORDER BY
    c.estoque_l ASC;


-- total vendido por funcionário
SELECT 
   f.nome,
   SUM(v.total) AS total_Funcionario
FROM 
   funcionario f
JOIN venda v
   ON v.funcionario_id = f.funcionario_id
GROUP BY
   f.nome;


--total vendido por combustível usando venda_item
SELECT
    c.nome,
    SUM(vi.quantidade_l * vi.preco_unitario) AS total_vendido
FROM combustivel c
JOIN venda_item vi
   ON vi.combustivel_id = c.combustivel_id
GROUP BY
    c.nome;

--Modifique as queries para incluir filtros por data e para ordenar por total vendido
SELECT
  c.nome,
  v.data_hora,
  SUM(vi.quantidade_l * vi.preco_unitario) AS total_vendido
FROM combustivel c
JOIN venda_item vi
   ON vi.combustivel_id = c.combustivel_id
JOIN venda v
   ON v.venda_id = vi.venda_id
WHERE v.data_hora > '2025-11-01 10:05:00'
GROUP BY
    c.nome, v.data_hora 
ORDER BY
    total_vendido ASC;
   

--Consultar a view com SELECT * FROM resumo_venda_combustivel

CREATE VIEW resumo_venda_combustivel AS
SELECT
  c.combustivel_id,
  c.nome,
  SUM(vi.quantidade_l) AS litros_vendidos,
  SUM(vi.quantidade_l * vi.preco_unitario) AS valor_vendido
FROM combustivel c
JOIN venda_item vi ON vi.combustivel_id = c.combustivel_id
GROUP BY c.combustivel_id, c.nome

SELECT * FROM resumo_venda_combustivel;


--Alterar a view para incluir preço medio por litro calculado como valor_vendido / litros_vendidos usando CREATE OR REPLACE VIEW
CREATE OR REPLACE VIEW resumo_venda_combustivel AS
SELECT
   c
   c.nome,
   SUM(vi.quantidade_l) AS litros_ven,
   SUM(vi.quantidade_l * vi.preco_unitario) AS valor_vendido,
FROM combustivel c
JOIN venda_item vi
   ON vi.combustivel_id = c.combustivel_id
GROUP BY
   c.nome;
    
   